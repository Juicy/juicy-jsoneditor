<!-- Import Polymer -->
<!-- <link rel="import" href="../../polymer/polymer.html"> -->
<script type="text/javascript" src="../../jsoneditor/jsoneditor.js"></script>
<script type="text/javascript" src="../../jsoneditor/asset/ace/ace.js"></script>
<!-- <script src="../../fast-json-patch/src/json-patch-duplex.js"></script> -->
<script src="../../fast-json-patch/src/json-patch.js"></script>

<!-- Define your custom element -->
<polymer-element name="juicy-jsoneditor" attributes="json mode modes name search indentation history">
    <template>
        <link rel="stylesheet" type="text/css" href="../../jsoneditor/jsoneditor.min.css">
        <style>
            :host{
                display: block;
            }
            #jsoneditorContainer{
                height: 100%;
            }
        </style>
        <div id="jsoneditorContainer"></div>
    </template>
    <script>
    (function(){
        var JSONEditorAPI = 
            ["set","setMode","setName","setText","get","getName","getText"];
        Polymer('juicy-jsoneditor', {
            json: null,
            editor: null,
            modes:[],
            search: true,
            history: false,
            // observer: null,
            created: function(){
                this.json = this.json || {};
                // this.observer = jsonpatch.observe( this.json, somethingChanged.bind(this) )
            },
            attached: function() {
                var that = this;
                var options = {
                    mode: this.mode,
                    history: this.history,
                    name: this.name,
                    modes: this.modes,
                    search: this.search,
                    indentation: this.indentation,

                    change: function editorChanged(patch){
                        if(that.editor){
                            // and we would like to keep at least root json object not replaced.
                            // josdejong/jsoneditor#87
                            that.dispatchEvent(
                                new CustomEvent("change", {
                                    detail: {
                                        action: patch,
                                        patch: patch
                                    }
                                })
                            );
                            jsonpatch.apply(that.json, [patch]);
                        }
                    }
                };

                this.editor = new JSONEditor(this.$.jsoneditorContainer, options);
                this.editor.set(this.json);

                //? observe json

                // Delegate JSONEditor API
                var apiNo = JSONEditorAPI.length;
                while(apiNo--){
                    this[ JSONEditorAPI[apiNo] ] = this.editor[ JSONEditorAPI[apiNo] ].bind( this.editor );
                }

            },
            detached: function(){
                // jsonpatch.unobserve( this.json, this.observer );
            },
            modeChanged: function modeChanged(){
                this.editor && this.editor.setMode(this.mode);
            },
            nameChanged: function nameChanged(){
                this.editor && this.editor.setName(this.name);
            },
            jsonChanged: function jsonChanged(){
                return this.refresh();
                // jsonpatch.unobserve( this.json, this.observer );
                // this.observer = jsonpatch.observe( this.json, somethingChanged.bind(this) )
            },
            refresh: function refresh(){
                return this.editor.set(this.json);
            }
        });


    }());
    </script>

}

</polymer-element>
